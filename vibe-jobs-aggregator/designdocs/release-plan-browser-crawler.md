# 浏览器版 Career Page 爬虫发布计划

## 目标
- 在现有调度框架内上线 Playwright 浏览器执行引擎，支持 Career Page 搜索、滚动、详情抓取。
- 确保限流与并发安全落地，避免对目标站点造成额外压力。
- 向运营团队提供新的配置指引与回滚方案。

## 里程碑
| 阶段 | 负责人 | 目标完成 | 交付物 |
|------|--------|----------|--------|
| 开发完成 | 后端团队 | T+0 | 代码合并、单元测试通过、配置示例更新 |
| 联调验证 | QA + 运营 | T+2 | 选取 2 家外企 Career Page（含搜索、含详情）完成抓取演练，输出数据质量报告 |
| 预生产灰度 | DevOps | T+4 | 预生产环境部署，运行 3 天稳定性观测（CPU/内存、抓取成功率、目标站点反馈） |
| 正式发布 | DevOps | T+7 | 生产部署，启用新蓝图（逐步放量：10% → 50% → 100%） |

## 发布步骤
1. **依赖预热**
   - 在构建镜像阶段执行 `npx playwright install chromium`，将浏览器缓存打入镜像或落到共享卷。
   - 检查生产容器是否允许 `--no-sandbox` 与 `--disable-dev-shm-usage` 参数。
2. **配置准备**
   - 为目标公司编写蓝图 `automation`/`flow`，确认 `rateLimit` ≤ 10 rpm、`concurrencyLimit` ≤ 2。
   - 在数据源 `baseOptions` 中设置默认搜索词，必要时通过 `overrideOptions` 覆盖。
3. **预生产验证**
   - 在预生产部署后，执行 `crawler` 类型数据源的手工触发，核对 `crawler_run_log` 中的成功率、耗时与限流命中情况。
   - QA 对照官网搜索结果，抽样校验职位标题、地点、链接与详情页内容。
4. **生产渐进式发布**
   - 生产环境部署后，先启用 1 家站点观察 24 小时，再根据成功率扩大到更多站点。
   - 通过监控观察 JVM 内存、CPU、线程数以及 Playwright 浏览器实例数量。
5. **回滚计划**
   - 若发现 Playwright 浏览器导致资源瓶颈，可在蓝图中将 `automation.enabled` 设为 `false` 临时回退至 HTTP 抓取。
   - 保留原有 `config_json` 版本，必要时在数据库中直接还原。

## 风险与缓解
- **浏览器驱动下载失败**：预先在镜像层安装，并在部署脚本中增加重试与 CDN 镜像。
- **目标站点限流/封禁**：严格执行 `rateLimit`、`concurrencyLimit`，并在 `CrawlerRateLimiter` 日志中记录等待时间以便排查。
- **解析失败**：上线前由运营补充 `flow` 与 `parser` 的冒烟测试脚本，发现 CSS 变化及时回滚。
- **资源占用过高**：开启 JVM & Playwright 指标监控（Grafana / Prometheus），若 CPU>70% 持续 10 分钟则自动降并发。

## 沟通与培训
- 为运营/配置人员开展 1 小时培训，讲解 `automation` 配置、常见错误与调试方式。
- 更新内部 Confluence 模板，提供蓝图示例与常见问题 FAQ。
- 发布周报向业务方同步上线时间、覆盖站点与初期抓取效果。

